<!-- Navigation -->
<nav class="nav">
    <div class="nav-container">
        <a href="/" class="nav-logo" data-nav-logo>tsuzuki817</a>
        <div class="nav-menu">
            <a href="/portfolio/" class="nav-link" data-nav-portfolio>Portfolio</a>
            <a href="/blog/posts/" class="nav-link" data-nav-blog>Blog</a>
            <a href="/about/" class="nav-link" data-nav-about>About</a>
            <a href="/contact/" class="nav-link" data-nav-contact>Contact</a>
            <div class="language-switcher">
                <div class="lang-dropdown">
                    <button class="lang-current">
                        <span class="lang-text" data-current-lang>日本語</span>
                        <span class="lang-arrow">▼</span>
                    </button>
                    <div class="lang-options" data-lang-options>
                        <!-- Language options will be generated by JavaScript -->
                    </div>
                </div>
            </div>
        </div>
        <div class="nav-toggle">
            <span></span>
            <span></span>
            <span></span>
        </div>
    </div>
</nav>

<script>
(function() {
    // Language configuration
    const LANGUAGES = {
        ja: { name: '日本語', code: 'ja' },
        en: { name: 'English', code: 'en' },
        ko: { name: '한국어', code: 'ko' }
    };
    
    // Get current language from URL params or localStorage
    function getCurrentLanguage() {
        // Check URL parameter first
        const urlParams = new URLSearchParams(window.location.search);
        const urlLang = urlParams.get('lang');
        
        if (urlLang && LANGUAGES[urlLang]) {
            // Save to localStorage if from URL
            localStorage.setItem('preferredLanguage', urlLang);
            return urlLang;
        }
        
        // Check localStorage
        const savedLang = localStorage.getItem('preferredLanguage');
        if (savedLang && LANGUAGES[savedLang]) {
            return savedLang;
        }
        
        // Default to Japanese
        return 'ja';
    }
    
    // Save language preference
    function saveLanguagePreference(lang) {
        localStorage.setItem('preferredLanguage', lang);
    }
    
    // Build URL with language parameter
    function buildLanguageUrl(targetLang) {
        const url = new URL(window.location.href);
        
        if (targetLang === 'ja') {
            // Japanese doesn't need lang parameter
            url.searchParams.delete('lang');
        } else {
            // Other languages need lang parameter
            url.searchParams.set('lang', targetLang);
        }
        
        return url.toString();
    }
    
    // Initialize language display
    function initializeLanguage() {
        const currentLang = getCurrentLanguage();
        
        // Save current language
        saveLanguagePreference(currentLang);
        
        // Update current language display
        const langText = document.querySelector('[data-current-lang]');
        if (langText) {
            langText.textContent = LANGUAGES[currentLang].name;
        }
        
        // Generate language options
        const langOptionsContainer = document.querySelector('[data-lang-options]');
        if (langOptionsContainer) {
            Object.entries(LANGUAGES).forEach(([code, lang]) => {
                const option = document.createElement('a');
                option.className = 'lang-option';
                option.dataset.lang = code;
                
                if (code === currentLang) {
                    option.href = '#';
                    option.className += ' active';
                    option.innerHTML = `${lang.name} <span class="lang-check">✓</span>`;
                } else {
                    option.href = buildLanguageUrl(code);
                    option.textContent = lang.name;
                    
                    // Add click handler to save preference
                    option.addEventListener('click', function(e) {
                        e.preventDefault();
                        saveLanguagePreference(code);
                        window.location.href = buildLanguageUrl(code);
                    });
                }
                
                langOptionsContainer.appendChild(option);
            });
        }
        
        // Dispatch language event for other components
        window.dispatchEvent(new CustomEvent('languageDetected', {
            detail: { language: currentLang }
        }));
    }
    
    // Mobile menu toggle
    const navToggle = document.querySelector('.nav-toggle');
    const navMenu = document.querySelector('.nav-menu');
    
    if (navToggle && navMenu) {
        navToggle.addEventListener('click', function() {
            navMenu.classList.toggle('active');
            navToggle.classList.toggle('active');
        });
    }
    
    // Language dropdown toggle
    const langDropdown = document.querySelector('.lang-dropdown');
    const langCurrent = document.querySelector('.lang-current');
    
    if (langDropdown && langCurrent) {
        langCurrent.addEventListener('click', function(e) {
            e.stopPropagation();
            langDropdown.classList.toggle('active');
        });
        
        // Close dropdown when clicking outside
        document.addEventListener('click', function() {
            langDropdown.classList.remove('active');
        });
    }
    
    // Initialize everything
    initializeLanguage();
    
    // Expose language info globally
    window.siteLanguage = {
        current: getCurrentLanguage(),
        saved: localStorage.getItem('preferredLanguage') || 'ja',
        available: LANGUAGES
    };
})();
</script>